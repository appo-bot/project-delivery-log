<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Delivery Log — Kanban (Optimized Editable)</title>
<style>
  :root { --gap: 12px; --card: #fff; --bg: #f6f7fb; --text:#222; --muted:#777; --border:#e3e6ef; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
  header { position: sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 12px; z-index:10; }
  .toolbar { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; max-width:1200px; margin:0 auto; }
  select, input { padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; }
  .page { max-width:1200px; margin:16px auto; padding:0 12px; }
  .cols { display:grid; grid-template-columns: repeat(3, 1fr); gap:var(--gap); }
  @media (max-width: 980px){ .cols { grid-template-columns: 1fr; } }
  .col { background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px; }
  .col h3 { margin:6px 8px 10px; font-size:16px; }
  .count { color:var(--muted); font-weight:400; margin-left:6px; }
  .list { display:flex; flex-direction:column; gap:8px; min-height:40px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; cursor:pointer; transition: box-shadow .2s ease; }
  .card:hover { box-shadow: 0 2px 10px rgba(0,0,0,.06); }
  .badge { font-size:12px; padding:3px 8px; border-radius:999px; background:#eef0f6; color:#445; border:1px solid var(--border); }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .meta { color:var(--muted); font-size:12px; margin-top:4px; display:flex; gap:12px; flex-wrap:wrap; }
  /* Drawer */
  .drawer { position: fixed; right:-520px; top:0; width:520px; max-width:100%; height:100%; background:#fff; border-left:1px solid var(--border); box-shadow: -8px 0 20px rgba(0,0,0,.05); transition:right .25s ease; z-index:100; display:flex; flex-direction:column; }
  .drawer.open { right:0; }
  .drawer header { padding:12px; border-bottom:1px solid var(--border); }
  .drawer .body { padding:12px; overflow:auto; }
  table { width:100%; border-collapse: collapse; margin-top:8px; }
  th, td { border-bottom:1px solid var(--border); padding:6px 8px; font-size:14px; text-align:left; }
  th { background:#fafbff; position:sticky; top:0; z-index:5; }
  .pill { display:inline-block; padding:2px 6px; border-radius:6px; background:#f1f3f9; font-size:12px; color:#555; border:1px solid var(--border); }
  .footer { padding:10px 12px; border-top:1px solid var(--border); color:var(--muted); font-size:12px; }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <strong>Kanban — Delivery Status</strong>
    <label>Floor:
      <select id="floorSel">
        <option value="">All floors</option>
      </select>
    </label>
    <label>Room:
      <input id="roomFilter" placeholder="e.g. 801" />
    </label>
    <span id="stamp" class="pill"></span>
  </div>
</header>

<div class="page">
  <div class="cols" id="cols">
    <div class="col" data-col="Not Delivered">
      <h3>Not Delivered <span class="count" id="c-not">0</span></h3>
      <div class="list" id="list-not"></div>
    </div>
    <div class="col" data-col="Partial">
      <h3>Partial <span class="count" id="c-par">0</span></h3>
      <div class="list" id="list-par"></div>
    </div>
    <div class="col" data-col="Complete">
      <h3>Complete <span class="count" id="c-com">0</span></h3>
      <div class="list" id="list-com"></div>
    </div>
  </div>
</div>

<!-- Drawer detalle editable -->
<aside class="drawer" id="drawer">
  <header>
    <div class="row">
      <div>
        <div id="d-title" style="font-weight:600"></div>
        <div id="d-sub" class="meta"></div>
      </div>
      <button id="d-close">Close</button>
    </div>
  </header>

  <div class="body">
    <h4>Item checklist</h4>
    <table>
      <thead>
        <tr>
          <th>ItemCode</th>
          <th>Required</th>
          <th>Delivered</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="d-rows"></tbody>
    </table>

    <h4 style="margin-top:12px;">Verification</h4>
    <div class="meta">
      <span><strong>Verified by:</strong></span>
      <select id="d-verifiedBy"></select>
    </div>

    <h4 style="margin-top:12px;">Notes</h4>
    <textarea id="d-notes" rows="3" style="width:100%;border:1px solid #e3e6ef;border-radius:8px;padding:8px;"></textarea>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <button id="d-save">Save delivery</button>
      <span id="d-msg" class="pill"></span>
    </div>

    <h4 style="margin-top:12px;">Bed Numbers</h4>
    <div class="meta">
      <span><strong>Queen:</strong> <span id="d-bedQ">—</span></span>
      <span><strong>King:</strong> <span id="d-bedK">—</span></span>
    </div>
  </div>
  <div class="footer">Source of truth: Google Sheets.</div>
</aside>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbzuJK9yrVHtURxhYlqP71qOg-2doYsoL8ry38Gus162VClilEdlQ_qgT7ud_wW3pJrX/exec';
const API_KEY = 'plog_4b3c9b5f_prod';

let RAW = { items: [], floors: [] };
let cacheStatus = null;
let cacheRooms = {};

const els = {
  floorSel: document.getElementById('floorSel'),
  roomFilter: document.getElementById('roomFilter'),
  stamp: document.getElementById('stamp'),
  lists: {
    not: document.getElementById('list-not'),
    par: document.getElementById('list-par'),
    com: document.getElementById('list-com'),
  },
  counts: {
    not: document.getElementById('c-not'),
    par: document.getElementById('c-par'),
    com: document.getElementById('c-com'),
  },
  drawer: document.getElementById('drawer'),
  closeBtn: document.getElementById('d-close')
};

// === Load board ===
async function load() {
  if (cacheStatus) { RAW = cacheStatus; render(); return; }
  const url = `${API_BASE}?action=kanban_status`;
  const res = await fetch(url);
  const data = await res.json();
  cacheStatus = data;
  RAW = data;
  fillFloors(data.floors || []);
  els.stamp.textContent = data.generatedAt ? new Date(data.generatedAt).toLocaleString() : '';
  render();
}

// === Fill floor dropdown ===
function fillFloors(floors){
  els.floorSel.innerHTML = '<option value="">All floors</option>';
  floors.forEach(f=>{
    const opt=document.createElement('option');
    opt.value=f;
    opt.textContent=`Floor ${f}`;
    els.floorSel.appendChild(opt);
  });
}

// === Render Kanban columns ===
function render(){
  const floor=els.floorSel.value.trim();
  const roomq=els.roomFilter.value.trim().toLowerCase();
  const filtered=RAW.items.filter(it=>{
    const okF=!floor||String(it.floor)===floor;
    const okR=!roomq||String(it.room).toLowerCase().includes(roomq);
    return okF&&okR;
  });
  ['not','par','com'].forEach(k=>els.lists[k].innerHTML='');
  let cNot=0,cPar=0,cCom=0;
  filtered.forEach(it=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div class="row">
        <div><strong>Floor ${it.floor}</strong> — Room <strong>${it.room}</strong></div>
        <span class="badge">${it.status}</span>
      </div>
      <div class="meta">
        <span>Type: ${it.roomType||'-'}</span>
        <span>ADA: ${it.ada||'-'}</span>
        <span>Delivered: ${it.delivered}/${it.required}</span>
      </div>`;
    card.onclick=()=>openDetail(it.floor,it.room,it);
    if(it.status==='Complete'){els.lists.com.appendChild(card);cCom++;}
    else if(it.status==='Partial'){els.lists.par.appendChild(card);cPar++;}
    else{els.lists.not.appendChild(card);cNot++;}
  });
  els.counts.not.textContent=cNot;
  els.counts.par.textContent=cPar;
  els.counts.com.textContent=cCom;
}

// === Drawer editable ===
async function openDetail(floor, room, meta){
  document.getElementById('d-title').textContent = `Room ${room} — Floor ${floor}`;
  document.getElementById('d-sub').innerHTML = `
    <span class="pill">Type: ${meta.roomType || '-'}</span>
    <span class="pill">ADA: ${meta.ada || '-'}</span>
    <span class="pill">Status: ${meta.status}</span>`;
  document.getElementById('d-rows').innerHTML = '<tr><td colspan="4">Loading…</td></tr>';
  document.getElementById('d-bedQ').textContent='—';
  document.getElementById('d-bedK').textContent='—';
  els.drawer.classList.add('open');

  // Users
  try {
    const users=await fetch(`${API_BASE}?action=users_list`).then(r=>r.json());
    const sel=document.getElementById('d-verifiedBy');
    sel.innerHTML='<option value="">-- select --</option>';
    (users.users||[]).forEach(u=>{
      const opt=document.createElement('option');
      opt.value=u; opt.textContent=u; sel.appendChild(opt);
    });
  }catch(_){document.getElementById('d-verifiedBy').innerHTML='<option value="">-- select --</option>'; }

  // Room detail
  const cacheKey=`${floor}-${room}`;
  let data;
  if(cacheRooms[cacheKey]) data=cacheRooms[cacheKey];
  else {
    const url=`${API_BASE}?action=room_detail&floor=${encodeURIComponent(floor)}&room=${encodeURIComponent(room)}`;
    data=await fetch(url).then(r=>r.json());
    cacheRooms[cacheKey]=data;
  }
  renderRoomDetailEditable(data,floor,room,meta);
}

function renderRoomDetailEditable(data,floor,room,meta){
  const tbody=document.getElementById('d-rows');
  tbody.innerHTML='';
  (data.rows||[]).forEach(r=>{
    const st=r.qtyDelivered>=r.qtyRequired?'Complete':r.qtyDelivered>0?'Partial':'Not delivered';
    const isMulti=Number(r.qtyRequired)>1;
    const fullChecked=r.qtyDelivered>=r.qtyRequired;
    const partialVal=fullChecked?0:Math.max(0,Math.min(Number(r.qtyDelivered||0),Number(r.qtyRequired||0)));
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.itemCode}</td>
      <td>${r.qtyRequired}</td>
      <td>
        <label style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input type="checkbox" class="chk-full" data-item="${r.itemCode}" data-req="${r.qtyRequired}" ${fullChecked?'checked':''}>
          <span>Full</span>
          ${isMulti?`
            <input type="number" class="inp-qty" data-item="${r.itemCode}" min="0" max="${r.qtyRequired}" step="1" value="${partialVal}" style="width:90px" ${fullChecked?'disabled':''}/>
            <span class="pill">Partial</span>`:''}
        </label>
        ${(r.isBedQueen||r.isBedKing)?`
          <div style="margin-top:6px;">
            <input type="text" placeholder="BedNumbers (comma-separated)" data-bed="${r.itemCode}" style="width:100%"/>
          </div>`:''}
      </td>
      <td>${st}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('d-bedQ').textContent=data.bedNumbers?.queen||'—';
  document.getElementById('d-bedK').textContent=data.bedNumbers?.king||'—';

  Array.from(document.querySelectorAll('.chk-full')).forEach(chk=>{
    chk.addEventListener('change',()=>{
      const code=chk.getAttribute('data-item');
      const req=Number(chk.getAttribute('data-req')||0);
      const spin=document.querySelector(`.inp-qty[data-item="${CSS.escape(code)}"]`);
      if(spin){
        if(chk.checked){spin.value=0;spin.disabled=true;}
        else{spin.disabled=false;const v=Number(spin.value||0);if(v>req)spin.value=req;if(v<0)spin.value=0;}
      }
    });
  });

  const btn=document.getElementById('d-save');
  const msg=document.getElementById('d-msg');
  btn.onclick=async()=>{
    msg.textContent='Saving...';
    const items=[];
    const chks=Array.from(document.querySelectorAll('.chk-full'));
    chks.forEach(chk=>{
      const code=chk.getAttribute('data-item');
      const req=Number(chk.getAttribute('data-req')||0);
      const spin=document.querySelector(`.inp-qty[data-item="${CSS.escape(code)}"]`);
      const bedI=document.querySelector(`input[data-bed="${CSS.escape(code)}"]`);
      let qty=0;
      if(chk.checked)qty=req; else if(spin)qty=Number(spin.value||0);
      if(qty>0){
        const obj={itemCode:code,qtyDelivered:qty};
        if(bedI)obj.bedNumbers=bedI.value.trim();
        items.push(obj);
      }
    });

    const verifiedBy=document.getElementById('d-verifiedBy').value.trim();
    const notes=document.getElementById('d-notes').value.trim();
    const bedCodes=new Set(['G-113','G-113A','G-114','G-114A']);
    for(const it of items){
      if(bedCodes.has(it.itemCode)){
        const count=(it.bedNumbers||'').split(',').map(s=>s.trim()).filter(Boolean).length;
        if(count!==Number(it.qtyDelivered||0)){msg.textContent='Error';alert(`BedNumbers must match qty for ${it.itemCode}`);return;}
      }
    }

    try{
      const body=new URLSearchParams();
      body.append('apiKey',API_KEY);
      body.append('action','submit_delivery');
      body.append('payload',JSON.stringify({floor:String(floor),room:String(room),verifiedBy,notes,items}));
      const resp=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body}).then(r=>r.json());
      if(resp&&resp.ok){
        msg.textContent='Saved ✅';
        cacheRooms[`${floor}-${room}`]=null; cacheStatus=null;
        await load();
        openDetail(floor,room,(RAW.items||[]).find(it=>String(it.floor)===String(floor)&&String(it.room)===String(room))||meta);
      }else{msg.textContent='Error';alert(resp.error||'Error saving');}
    }catch(err){msg.textContent='Error';alert(err.message||String(err));}
  };
}

els.closeBtn.addEventListener('click',()=>els.drawer.classList.remove('open'));
els.floorSel.addEventListener('change',render);
els.roomFilter.addEventListener('input',render);
load();
</script>
</body>
</html>
